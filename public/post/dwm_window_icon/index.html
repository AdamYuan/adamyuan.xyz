<!DOCTYPE html>
<html><head>
<title>为DWM添加窗口图标</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">











<script src="/vendor/js/jquery.min.js" ></script>
<script src="/vendor/js/popper.min.js" ></script>
<script src="/vendor/js/bootstrap.min.js" ></script>
<script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>




<link rel="icon" href="/favicon.png">




<link rel="stylesheet" href="https://adamyuan.xyz/scss/journal.min.620abb9176990045b15c3ca21b17424251589ea80c249e8ca138967324b1b4e1.css" integrity="sha256-Ygq7kXaZAEWxXDyiGxdCQlFYnqgMJJ6MoTiWcySxtOE=" media="screen">



<script src="https://adamyuan.xyz//js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Lora|Roboto|Source+Code+Pro|Noto+Sans+SC|Material+Icons");
</script>


  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
<script>
	document.addEventListener("DOMContentLoaded", function() {
		renderMathInElement(document.body, {
			delimiters: [
				{left: "$$", right: "$$", display: false},
				{left: "\\(", right: "\\)", display: false},
				{left: "\\[", right: "\\]", display: true}
			]
		});
	});
</script>




  
    <script src="https://adamyuan.xyz//js/toc.js"></script>
  



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="/vendor/js/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
  clientID: '214b3bed54d2162cf2f3',
  clientSecret: '71543566573e2fa931b301f49339b09051e4eb61',
  repo: 'adamyuan.xyz',
  owner: 'AdamYuan',
  admin: ['AdamYuan'],
  id: md5(location.pathname),
  distractionFreeMode: 'false'
  });
  window.onload = function () {
        gitalk.render('gitalk-container')
  }
</script>








</head>
<body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://adamyuan.xyz/">
    
        <div class="nav-title">
            AdamYuan-&gt;Blog
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/post">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2020 AdamYuan.
	

    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%89%8d%e8%a8%80" onclick="onNavClick(`#前言-nav`)" id="前言-nav">
									前言
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86" onclick="onNavClick(`#内存管理-nav`)" id="内存管理-nav">
									内存管理
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#freeicon%e5%92%8cupdateicon" onclick="onNavClick(`#freeicon和updateicon-nav`)" id="freeicon和updateicon-nav">
									freeicon和updateicon
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bf%ae%e6%94%b9manage%e5%92%8cunmanage%e5%87%bd%e6%95%b0" onclick="onNavClick(`#修改manage和unmanage函数-nav`)" id="修改manage和unmanage函数-nav">
									修改manage和unmanage函数
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%8d%95%e8%8e%b7%e5%9b%be%e6%a0%87%e6%9b%b4%e6%96%b0%e4%ba%8b%e4%bb%b6" onclick="onNavClick(`#捕获图标更新事件-nav`)" id="捕获图标更新事件-nav">
									捕获图标更新事件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%9b%be%e6%a0%87%e8%8e%b7%e5%8f%96%e4%b8%8e%e5%88%9b%e5%bb%ba" onclick="onNavClick(`#图标获取与创建-nav`)" id="图标获取与创建-nav">
									图标获取与创建
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#xgetwindowproperty%e7%9c%9ftm%e9%9a%be%e7%94%a8" onclick="onNavClick(`#xgetwindowproperty真tm难用-nav`)" id="xgetwindowproperty真tm难用-nav">
									XGetWindowProperty真TM难用
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%80%89%e6%8b%a9%e6%9c%80%e4%bc%98%e5%9b%be%e6%a0%87" onclick="onNavClick(`#选择最优图标-nav`)" id="选择最优图标-nav">
									选择最优图标
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bd%bf%e7%94%a8stb_image_resizeh%e7%bc%a9%e6%94%be%e5%9b%be%e6%a0%87" onclick="onNavClick(`#使用stb_image_resizeh缩放图标-nav`)" id="使用stb_image_resizeh缩放图标-nav">
									使用stb_image_resize.h缩放图标
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%96%84%e5%90%8e" onclick="onNavClick(`#善后-nav`)" id="善后-nav">
									善后
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e7%bb%98%e5%88%b6" onclick="onNavClick(`#绘制-nav`)" id="绘制-nav">
									绘制
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#%e4%b8%ba%e5%9b%be%e6%a0%87%e8%85%be%e5%87%ba%e7%a9%ba%e9%97%b4" onclick="onNavClick(`#为图标腾出空间-nav`)" id="为图标腾出空间-nav">
									为图标腾出空间
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bd%bf%e7%94%a8xputimage" onclick="onNavClick(`#使用xputimage-nav`)" id="使用xputimage-nav">
									使用XPutImage
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%89%8b%e5%8a%a8alpha-blend" onclick="onNavClick(`#手动alpha-blend-nav`)" id="手动alpha-blend-nav">
									手动Alpha Blend
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        
    </div>
</div><div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/post">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%89%8d%e8%a8%80" onclick="onNavClick(`#前言-nav`)" id="前言-nav">
									前言
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86" onclick="onNavClick(`#内存管理-nav`)" id="内存管理-nav">
									内存管理
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#freeicon%e5%92%8cupdateicon" onclick="onNavClick(`#freeicon和updateicon-nav`)" id="freeicon和updateicon-nav">
									freeicon和updateicon
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bf%ae%e6%94%b9manage%e5%92%8cunmanage%e5%87%bd%e6%95%b0" onclick="onNavClick(`#修改manage和unmanage函数-nav`)" id="修改manage和unmanage函数-nav">
									修改manage和unmanage函数
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%8d%95%e8%8e%b7%e5%9b%be%e6%a0%87%e6%9b%b4%e6%96%b0%e4%ba%8b%e4%bb%b6" onclick="onNavClick(`#捕获图标更新事件-nav`)" id="捕获图标更新事件-nav">
									捕获图标更新事件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%9b%be%e6%a0%87%e8%8e%b7%e5%8f%96%e4%b8%8e%e5%88%9b%e5%bb%ba" onclick="onNavClick(`#图标获取与创建-nav`)" id="图标获取与创建-nav">
									图标获取与创建
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#xgetwindowproperty%e7%9c%9ftm%e9%9a%be%e7%94%a8" onclick="onNavClick(`#xgetwindowproperty真tm难用-nav`)" id="xgetwindowproperty真tm难用-nav">
									XGetWindowProperty真TM难用
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%80%89%e6%8b%a9%e6%9c%80%e4%bc%98%e5%9b%be%e6%a0%87" onclick="onNavClick(`#选择最优图标-nav`)" id="选择最优图标-nav">
									选择最优图标
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bd%bf%e7%94%a8stb_image_resizeh%e7%bc%a9%e6%94%be%e5%9b%be%e6%a0%87" onclick="onNavClick(`#使用stb_image_resizeh缩放图标-nav`)" id="使用stb_image_resizeh缩放图标-nav">
									使用stb_image_resize.h缩放图标
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%96%84%e5%90%8e" onclick="onNavClick(`#善后-nav`)" id="善后-nav">
									善后
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e7%bb%98%e5%88%b6" onclick="onNavClick(`#绘制-nav`)" id="绘制-nav">
									绘制
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#%e4%b8%ba%e5%9b%be%e6%a0%87%e8%85%be%e5%87%ba%e7%a9%ba%e9%97%b4" onclick="onNavClick(`#为图标腾出空间-nav`)" id="为图标腾出空间-nav">
									为图标腾出空间
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bd%bf%e7%94%a8xputimage" onclick="onNavClick(`#使用xputimage-nav`)" id="使用xputimage-nav">
									使用XPutImage
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%89%8b%e5%8a%a8alpha-blend" onclick="onNavClick(`#手动alpha-blend-nav`)" id="手动alpha-blend-nav">
									手动Alpha Blend
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://adamyuan.xyz/">
            AdamYuan-&gt;Blog
        </a>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://adamyuan.xyz/">
        <div class="single-column-header-title">AdamYuan-&gt;Blog</div>
        

    </a>
</div>
            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('https://adamyuan.xyz/img/dwm_window_icon/feature.png')"
                    
                
            >
                <div class="post-title">
                    为DWM添加窗口图标
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2021-06-23 13:43
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                            
                                <a href="/categories/linux">[Linux]</a>
                                &nbsp;
                            
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/dwm">dwm</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h1 id="前言">前言</h1>
<p>最近几天高考结束，分(huang)数(de)没(yi)出(pi)，闲在家里，于是折腾了一下DWM。DWM的动态平铺方式简单有效，无需I3WM那样繁琐的操作(对小屏幕尤其友好)。同时3000行左右的代码层次分明，简单易懂，其中<strong>dwm.c</strong>负责窗口的管理逻辑与界面更新、<strong>drw.c/.h</strong>提供基础绘制、<strong>config.h</strong>作为配置文件，只要有C语言基础便能轻松地根据自身需求进行修改，可拓展性极高。<br>
原生的DWM不会在title bar显示窗口图标，总感觉缺了点味道。恰好DWM的底层Xlib中也有XImage类型、XCreateImage、XPutImage及XGetWindowProperty等函数可以获取窗口图标并储存、绘制，于是决定自己实现。<br>
本人之前从未接触过Xlib相关的程序编写，对于一些概念的使用可能有误区，实现方式也未必最优，欢迎大家指正。</p>
<h1 id="内存管理">内存管理</h1>
<p>在DWM中，每个窗口的数据是由结构体Client管理的，要想实现窗口图标，便要在Client结构体中添加图标的数据(直接加入一个XImage指针即可)，如图：<br>
<img src="/img/dwm_window_icon/client.png" alt=""><br>
icon使用动态内存的方式管理，因此需要妥善进行分配与释放，防止内存泄露。<br>
显然，窗口图标和窗口标题的处理方式十分相似，都要在窗口创建时初始化，也都可能触发更新，可以仿照DWM管理窗口标题的方式来处理窗口图标。</p>
<h2 id="freeicon和updateicon">freeicon和updateicon</h2>
<p>窗口图标使用了动态内存，于是首先在<strong>dwm.c</strong>新增一个freeicon函数用于释放，如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">freeicon</span>(Client <span style="color:#f92672">*</span>c) {
	<span style="color:#66d9ef">if</span> (c<span style="color:#f92672">-&gt;</span>icon) {
		XDestroyImage(c<span style="color:#f92672">-&gt;</span>icon);
		c<span style="color:#f92672">-&gt;</span>icon <span style="color:#f92672">=</span> NULL;
	}
}
</code></pre></div><p>同时在<strong>dwm.c</strong>中，窗口标题的获取使用updatetitle函数实现，于是我们也添加一个updateicon函数，如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">updateicon</span>(Client <span style="color:#f92672">*</span>c) {
	freeicon(c); <span style="color:#75715e">// 都更新了当然要把旧图标先释放掉啊
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 后面再写
</span><span style="color:#75715e"></span>}
</code></pre></div><h2 id="修改manage和unmanage函数">修改manage和unmanage函数</h2>
<p><strong>dwm.c</strong>中，manage函数的功能为将新创建的窗口列入DWM的管理下，具体包括为窗口alloc一个Client，初始其标题、大小等信息。manage函数中调用了updatetitle，我们也照葫芦画瓢调用updateicon，如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">manage</span>(Window w, XWindowAttributes <span style="color:#f92672">*</span>wa) {
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	c<span style="color:#f92672">-&gt;</span>icon <span style="color:#f92672">=</span> NULL;
	updateicon(c);
	updatetitle(c);
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</code></pre></div><p>而unmanage函数在窗口关闭或退出DWM时调用，负责销毁窗口的Client，我们在其中加入freeicon，如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">unmanage</span>(Client <span style="color:#f92672">*</span>c, <span style="color:#66d9ef">int</span> destroyed) {
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	detachstack(c);
	freeicon(c);
	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>destroyed) {
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</code></pre></div><h2 id="捕获图标更新事件">捕获图标更新事件</h2>
<p>(Xlib相关，其实我也不大懂)首先在<strong>dwm.c</strong>中加入以下两处代码：<br>
<img src="/img/dwm_window_icon/netwmicon.png" alt=""><br>
而后将propertynotify函数修改如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">propertynotify</span>(XEvent <span style="color:#f92672">*</span>e)
{
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">break</span>;
		<span style="color:#66d9ef">case</span> XA_WM_HINTS:
			updatewmhints(c);
			drawbars();
			<span style="color:#66d9ef">break</span>;
		}

		<span style="color:#66d9ef">int</span> ub <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, rdb <span style="color:#f92672">=</span> c <span style="color:#f92672">==</span> c<span style="color:#f92672">-&gt;</span>mon<span style="color:#f92672">-&gt;</span>sel;
		<span style="color:#75715e">// 保存是否调用drawbar函数的状态，防止重复调用drawbar函数
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> (ev<span style="color:#f92672">-&gt;</span>atom <span style="color:#f92672">==</span> XA_WM_NAME <span style="color:#f92672">||</span> ev<span style="color:#f92672">-&gt;</span>atom <span style="color:#f92672">==</span> netatom[NetWMName]) {
			updatetitle(c);
			ub <span style="color:#f92672">=</span> rdb;
		}
		<span style="color:#66d9ef">if</span> (ev<span style="color:#f92672">-&gt;</span>atom <span style="color:#f92672">==</span> netatom[NetWMIcon]) { <span style="color:#75715e">// [新增]在图标更新时调用updateicon函数
</span><span style="color:#75715e"></span>			updateicon(c);
			ub <span style="color:#f92672">=</span> rdb;
		}

		<span style="color:#66d9ef">if</span> (ub) drawbar(c<span style="color:#f92672">-&gt;</span>mon);

		<span style="color:#66d9ef">if</span> (ev<span style="color:#f92672">-&gt;</span>atom <span style="color:#f92672">==</span> netatom[NetWMWindowType])
			updatewindowtype(c);
	}
}
</code></pre></div><p>这样便完成了图标的内存管理，接下来便要完善updateicon函数以获取并创建图标。</p>
<h1 id="图标获取与创建">图标获取与创建</h1>
<h2 id="xgetwindowproperty真tm难用">XGetWindowProperty真TM难用</h2>
<p>在Xlib中，窗口图标的获取可以通过XGetWindowProperty函数完成。<br>
首先创建一个函数，该函数目的为从一个窗口获取图标并返回一个XImage指针(若没有图标则返回NULL)，如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">XImage <span style="color:#f92672">*</span>
<span style="color:#a6e22e">geticonprop</span>(Window win)
{
	<span style="color:#66d9ef">int</span> format;
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> n, extra, <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> NULL;
	Atom real;

	<span style="color:#66d9ef">if</span> (XGetWindowProperty(dpy, win, netatom[NetWMIcon], <span style="color:#ae81ff">0L</span>, LONG_MAX, False, AnyPropertyType, 
						   <span style="color:#f92672">&amp;</span>real, <span style="color:#f92672">&amp;</span>format, <span style="color:#f92672">&amp;</span>n, <span style="color:#f92672">&amp;</span>extra, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>)<span style="color:#f92672">&amp;</span>p) <span style="color:#f92672">!=</span> Success) { 
		<span style="color:#66d9ef">return</span> NULL; 
	}
	<span style="color:#66d9ef">if</span> (n <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { XFree(p); <span style="color:#66d9ef">return</span> NULL; }

	<span style="color:#75715e">// 后面再写...
</span><span style="color:#75715e"></span>}
</code></pre></div><p>该函数的开头部分调用XGetWindowProperty，返回的主要数据为包含窗口图标大小和RGBA数据的unsigned long数组<strong>p</strong>，以及表示数组长度的整数<strong>n</strong>，接下来需要解析这些数据。<br>
众所周知，一个窗口通常会提供不同大小的图标以适应不同的缩放(dpi?)。数组<strong>p</strong>中的数据也不例外，包含的多组图标，其数据组成十分简单粗暴：所有图标的数据紧密排布；每个图标数据的其前两项包含一个图表的长宽，即w和h，后面w*h项为图标中每个像素点的RGBA数据。</p>
<h2 id="选择最优图标">选择最优图标</h2>
<p>在window manager中，我们希望显示出的窗口图标维持在一个固定、不变的尺寸，而窗口提供的多个图标未必能正好满足该尺寸要求，因此需要选择一个最优的图标进行缩放。<br>
于是首先在<strong>config.h</strong>中加入一行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#define ICONSIZE 20 </span><span style="color:#75715e">// 图标的目标尺寸，可修改
</span></code></pre></div><p>由于图像处理中down sampling(缩小)通常比up sampling(放大)效果更佳，我们希望选择大于目标尺寸的图标，又因为(根据常识)目标尺寸与原尺寸相差越大的down sampling计算量越大，因此，我们认为所有图标中大于等于目标尺寸的最小图标为最优。<br>
当然有一种特殊情况，即所有图表的尺寸都小于目标尺寸，这时只能选择最接近目标尺寸的图标。<br>
根据这个思路，很容易写出如下代码(geticonprop函数中)：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>bstp <span style="color:#f92672">=</span> NULL, w, h;

{ <span style="color:#75715e">// 选择最优图标，bstp指针表示最优图标的数据位置
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>end <span style="color:#f92672">=</span> p <span style="color:#f92672">+</span> n;
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>i;
	<span style="color:#66d9ef">int</span> bstd <span style="color:#f92672">=</span> INT_MAX, d, m;
	<span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> p; i <span style="color:#f92672">&lt;</span> end; ) { <span style="color:#75715e">// 首选大于等于ICONSIZE的最小图标
</span><span style="color:#75715e"></span>		w <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>i<span style="color:#f92672">++</span>; h <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>i<span style="color:#f92672">++</span>;
		m <span style="color:#f92672">=</span> w <span style="color:#f92672">&gt;</span> h <span style="color:#f92672">?</span> w : h;
		<span style="color:#66d9ef">if</span> (m <span style="color:#f92672">&gt;=</span> ICONSIZE <span style="color:#f92672">&amp;&amp;</span> (d <span style="color:#f92672">=</span> m <span style="color:#f92672">-</span> ICONSIZE) <span style="color:#f92672">&lt;</span> bstd) { bstd <span style="color:#f92672">=</span> d; bstp <span style="color:#f92672">=</span> i; }
		i <span style="color:#f92672">+=</span> (w <span style="color:#f92672">*</span> h);
	}
	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>bstp) { <span style="color:#75715e">// 若没有，则选择最接近ICONSIZE的图标
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> p; i <span style="color:#f92672">&lt;</span> end; ) {
			w <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>i<span style="color:#f92672">++</span>; h <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>i<span style="color:#f92672">++</span>;
			m <span style="color:#f92672">=</span> w <span style="color:#f92672">&gt;</span> h <span style="color:#f92672">?</span> w : h;
			<span style="color:#66d9ef">if</span> ((d <span style="color:#f92672">=</span> ICONSIZE <span style="color:#f92672">-</span> m) <span style="color:#f92672">&lt;</span> bstd) { bstd <span style="color:#f92672">=</span> d; bstp <span style="color:#f92672">=</span> i; }
			i <span style="color:#f92672">+=</span> (w <span style="color:#f92672">*</span> h);
		}
	}
	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>bstp) { XFree(p); <span style="color:#66d9ef">return</span> NULL; } <span style="color:#75715e">// 再没有，躺平，返回NULL
</span><span style="color:#75715e"></span>}

w <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(bstp <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>); h <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(bstp <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>); <span style="color:#75715e">// 从bstp中读取最优图标的长宽
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> icw, ich; <span style="color:#75715e">// 根据ICONSIZE、w、h，计算缩放后的图标长宽icw、ich
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (w <span style="color:#f92672">&lt;=</span> h) {
	ich <span style="color:#f92672">=</span> ICONSIZE; icw <span style="color:#f92672">=</span> w <span style="color:#f92672">*</span> ICONSIZE <span style="color:#f92672">/</span> h;
	<span style="color:#66d9ef">if</span> (icw <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>) icw <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
	<span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (icw <span style="color:#f92672">&gt;</span> ICONSIZE) icw <span style="color:#f92672">=</span> ICONSIZE;
}
<span style="color:#66d9ef">else</span> {
	icw <span style="color:#f92672">=</span> ICONSIZE; ich <span style="color:#f92672">=</span> h <span style="color:#f92672">*</span> ICONSIZE <span style="color:#f92672">/</span> w;
	<span style="color:#66d9ef">if</span> (ich <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>) ich <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
	<span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (ich <span style="color:#f92672">&gt;</span> ICONSIZE) ich <span style="color:#f92672">=</span> ICONSIZE;
}
</code></pre></div><h2 id="使用stb_image_resizeh缩放图标">使用stb_image_resize.h缩放图标</h2>
<p>获得了最优图标并计算出目标长宽后，我们就需要缩放图标。<br>
图像的缩放并不是一件容易的工作，需要不少复杂算法，简便起见，我直接使用了计算机图形学代码常用的<a href="https://github.com/nothings/stb/blob/master/stb_image_resize.h">stb_image_resize.h</a>，其中的stbir_resize_uint8函数可以较为高效地完成这个任务。<br>
首先我们下载stb_image_resize.h到DWM的代码目录，而后将其include，如图：<br>
<img src="/img/dwm_window_icon/include_stbir.png" alt=""><br>
stbir_resize_uint8函数需要传入紧密排布的32位rgba图像数据，而我们选定的图标数组<strong>bstp</strong>为unsigned long数组。在一些平台(32位?)中unsigned long为32位整数，此时<strong>bstp</strong>恰好满足要求；而现代多数64位平台中unsigned long为64位整数，于是<strong>bstp</strong>数组便有间隔空缺，无法满足要求。由于Xlib的该历史包袱，在实现中需要根据情况对<strong>bstp</strong>数组进行转换。<br>
根据上述思路，容易写出如下代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// 申请缩放后的图标的内存空间
</span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>icbuf <span style="color:#f92672">=</span> malloc(icw <span style="color:#f92672">*</span> ich <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>); <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>icbuf) { XFree(p); <span style="color:#66d9ef">return</span> NULL; }

<span style="color:#75715e">#if ULONG_MAX &gt; UINT32_MAX </span><span style="color:#75715e">// 如果unsigned long长度大于32位，对bstp数组进行转换(c语言标准保证unsigned long长度至少为32位)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> i, sz <span style="color:#f92672">=</span> w <span style="color:#f92672">*</span> h;
uint32_t <span style="color:#f92672">*</span>bstp32 <span style="color:#f92672">=</span> (uint32_t <span style="color:#f92672">*</span>)bstp;
<span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> sz; <span style="color:#f92672">++</span>i) bstp32[i] <span style="color:#f92672">=</span> bstp[i];
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">if</span> (w <span style="color:#f92672">==</span> icw <span style="color:#f92672">&amp;&amp;</span> h <span style="color:#f92672">==</span> ich) memcpy(icbuf, bstp, icw <span style="color:#f92672">*</span> ich <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>); <span style="color:#75715e">// 如果无需缩放，直接复制
</span><span style="color:#75715e"></span><span style="color:#66d9ef">else</span> <span style="color:#a6e22e">stbir_resize_uint8</span>((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)bstp, w, h, <span style="color:#ae81ff">0</span>, icbuf, icw, ich, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>); <span style="color:#75715e">// 否则，调用stbir_resize_uint8进行缩放
</span><span style="color:#75715e"></span>XFree(p);
</code></pre></div><p>最后只需从<strong>icbuf</strong>数组创建并返回XImage指针，如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">return</span> <span style="color:#a6e22e">XCreateImage</span>(dpy, DefaultVisual(dpy, screen), DefaultDepth(dpy, screen), ZPixmap, <span style="color:#ae81ff">0</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)icbuf, icw, ich, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">0</span>);
</code></pre></div><h2 id="善后">善后</h2>
<p>最终的geticonprop函数如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#define STB_IMAGE_RESIZE_IMPLEMENTATION
</span><span style="color:#75715e">#define STBIR_DEFAULT_FILTER_DOWNSAMPLE STBIR_FILTER_BOX
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;stb_image_resize.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
XImage <span style="color:#f92672">*</span>
<span style="color:#a6e22e">geticonprop</span>(Window win)
{
	<span style="color:#66d9ef">int</span> format;
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> n, extra, <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> NULL;
	Atom real;

	<span style="color:#66d9ef">if</span> (XGetWindowProperty(dpy, win, netatom[NetWMIcon], <span style="color:#ae81ff">0L</span>, LONG_MAX, False, AnyPropertyType, 
						   <span style="color:#f92672">&amp;</span>real, <span style="color:#f92672">&amp;</span>format, <span style="color:#f92672">&amp;</span>n, <span style="color:#f92672">&amp;</span>extra, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>)<span style="color:#f92672">&amp;</span>p) <span style="color:#f92672">!=</span> Success)
		<span style="color:#66d9ef">return</span> NULL; 
	<span style="color:#66d9ef">if</span> (n <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { XFree(p); <span style="color:#66d9ef">return</span> NULL; }

	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>bstp <span style="color:#f92672">=</span> NULL, w, h;

	{
		<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>end <span style="color:#f92672">=</span> p <span style="color:#f92672">+</span> n;
		<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>i;
		<span style="color:#66d9ef">int</span> bstd <span style="color:#f92672">=</span> INT_MAX, d, m;
		<span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> p; i <span style="color:#f92672">&lt;</span> end; ) {
			w <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>i<span style="color:#f92672">++</span>; h <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>i<span style="color:#f92672">++</span>;
			m <span style="color:#f92672">=</span> w <span style="color:#f92672">&gt;</span> h <span style="color:#f92672">?</span> w : h;
			<span style="color:#66d9ef">if</span> (m <span style="color:#f92672">&gt;=</span> ICONSIZE <span style="color:#f92672">&amp;&amp;</span> (d <span style="color:#f92672">=</span> m <span style="color:#f92672">-</span> ICONSIZE) <span style="color:#f92672">&lt;</span> bstd) { bstd <span style="color:#f92672">=</span> d; bstp <span style="color:#f92672">=</span> i; }
			i <span style="color:#f92672">+=</span> (w <span style="color:#f92672">*</span> h);
		}
		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>bstp) {
			<span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> p; i <span style="color:#f92672">&lt;</span> end; ) {
				w <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>i<span style="color:#f92672">++</span>; h <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>i<span style="color:#f92672">++</span>;
				m <span style="color:#f92672">=</span> w <span style="color:#f92672">&gt;</span> h <span style="color:#f92672">?</span> w : h;
				<span style="color:#66d9ef">if</span> ((d <span style="color:#f92672">=</span> ICONSIZE <span style="color:#f92672">-</span> m) <span style="color:#f92672">&lt;</span> bstd) { bstd <span style="color:#f92672">=</span> d; bstp <span style="color:#f92672">=</span> i; }
				i <span style="color:#f92672">+=</span> (w <span style="color:#f92672">*</span> h);
			}
		}
		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>bstp) { XFree(p); <span style="color:#66d9ef">return</span> NULL; }
	}

	w <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(bstp <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>); h <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(bstp <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);

	<span style="color:#66d9ef">int</span> icw, ich;
	<span style="color:#66d9ef">if</span> (w <span style="color:#f92672">&lt;=</span> h) {
		ich <span style="color:#f92672">=</span> ICONSIZE; icw <span style="color:#f92672">=</span> w <span style="color:#f92672">*</span> ICONSIZE <span style="color:#f92672">/</span> h;
		<span style="color:#66d9ef">if</span> (icw <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>) icw <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
		<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (icw <span style="color:#f92672">&gt;</span> ICONSIZE) icw <span style="color:#f92672">=</span> ICONSIZE;
	}
	<span style="color:#66d9ef">else</span> {
		icw <span style="color:#f92672">=</span> ICONSIZE; ich <span style="color:#f92672">=</span> h <span style="color:#f92672">*</span> ICONSIZE <span style="color:#f92672">/</span> w;
		<span style="color:#66d9ef">if</span> (ich <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>) ich <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
		<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (ich <span style="color:#f92672">&gt;</span> ICONSIZE) ich <span style="color:#f92672">=</span> ICONSIZE;
	}

	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>icbuf <span style="color:#f92672">=</span> malloc(icw <span style="color:#f92672">*</span> ich <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>); <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>icbuf) { XFree(p); <span style="color:#66d9ef">return</span> NULL; }
<span style="color:#75715e">#if ULONG_MAX &gt; UINT32_MAX
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> i, sz <span style="color:#f92672">=</span> w <span style="color:#f92672">*</span> h;
	uint32_t <span style="color:#f92672">*</span>bstp32 <span style="color:#f92672">=</span> (uint32_t <span style="color:#f92672">*</span>)bstp;
	<span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> sz; <span style="color:#f92672">++</span>i) bstp32[i] <span style="color:#f92672">=</span> bstp[i];
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (w <span style="color:#f92672">==</span> icw <span style="color:#f92672">&amp;&amp;</span> h <span style="color:#f92672">==</span> ich) memcpy(icbuf, bstp, icw <span style="color:#f92672">*</span> ich <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>);
	<span style="color:#66d9ef">else</span> stbir_resize_uint8((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)bstp, w, h, <span style="color:#ae81ff">0</span>, icbuf, icw, ich, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>);
	XFree(p);

	<span style="color:#66d9ef">return</span> XCreateImage(dpy, DefaultVisual(dpy, screen), DefaultDepth(dpy, screen), ZPixmap, <span style="color:#ae81ff">0</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)icbuf, icw, ich, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">0</span>);
}
</code></pre></div><p>之后只需在updateicon函数中调用geticonprop，即可完成图标从创建、更新到销毁的完整生命周期，如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">updateicon</span>(Client <span style="color:#f92672">*</span>c)
{
	freeicon(c);
	c<span style="color:#f92672">-&gt;</span>icon <span style="color:#f92672">=</span> geticonprop(c<span style="color:#f92672">-&gt;</span>win);
}
</code></pre></div><h1 id="绘制">绘制</h1>
<p>完成了图标资源的管理，最后的任务便是将图标绘制出来。</p>
<h2 id="为图标腾出空间">为图标腾出空间</h2>
<p>显然在图标绘制过程当中，我们希望图标与标题文字间隔一定距离，于是首先在<strong>config.h</strong>中加入一行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> iconspacing <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;
</code></pre></div><p>而后修改<strong>dwm.c</strong>中的drawbar函数，做如下修改:<br>
<img src="/img/dwm_window_icon/icon_spacing.png" alt=""></p>
<h2 id="使用xputimage">使用XPutImage</h2>
<p>之后的任务便是使用Xlib中的XPutImage函数在空出的区域绘制图标。为此，首先在<strong>drw.h</strong>中加入以下函数定义(其中tmp参数的作用之后说明)：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">drw_img</span>(Drw <span style="color:#f92672">*</span>drw, <span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">int</span> y, XImage <span style="color:#f92672">*</span>img, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>tmp);
</code></pre></div><p>该函数在<strong>drw.c</strong>中的实现十分简单，只需调用XPutImage，如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">drw_img</span>(Drw <span style="color:#f92672">*</span>drw, <span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">int</span> y, XImage <span style="color:#f92672">*</span>img, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>tmp) 
{
	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>drw <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>drw<span style="color:#f92672">-&gt;</span>scheme)
		<span style="color:#66d9ef">return</span>;
	XPutImage(drw<span style="color:#f92672">-&gt;</span>dpy, drw<span style="color:#f92672">-&gt;</span>drawable, drw<span style="color:#f92672">-&gt;</span>gc, img, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, x, y, img<span style="color:#f92672">-&gt;</span>width, img<span style="color:#f92672">-&gt;</span>height);
}
</code></pre></div><p>然后在drawbar函数中恰当调用drw_img函数，即可完成图标的绘制，如图：<br>
<img src="/img/dwm_window_icon/call_drw_img.png" alt=""></p>
<h2 id="手动alpha-blend">手动Alpha Blend</h2>
<p>上述步骤虽然完成了图标的绘制，但并没有考虑其alpha channel，于是图标周围显示了一圈黑边，效果不理想。<br>
<img src="/img/dwm_window_icon/no_blend.png" alt=""><br>
由于原生的Xlib没有alpha blend功能，若使用XRender又过于繁琐，因此我选择自己实现一个简单的alpha blend。<br>
alpha blend原理简单，这里不再追述，将drw_img函数修改如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> 
<span style="color:#a6e22e">blend</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> a, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> x, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> y) { <span style="color:#66d9ef">return</span> ((<span style="color:#ae81ff">255</span><span style="color:#f92672">-</span>a)<span style="color:#f92672">*</span>x <span style="color:#f92672">+</span> a<span style="color:#f92672">*</span>y) <span style="color:#f92672">/</span> <span style="color:#ae81ff">255</span>; }

<span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">drw_img</span>(Drw <span style="color:#f92672">*</span>drw, <span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">int</span> y, XImage <span style="color:#f92672">*</span>img, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>tmp) 
{
	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>drw <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>drw<span style="color:#f92672">-&gt;</span>scheme)
		<span style="color:#66d9ef">return</span>;
	<span style="color:#66d9ef">int</span> icsz <span style="color:#f92672">=</span> img<span style="color:#f92672">-&gt;</span>width <span style="color:#f92672">*</span> img<span style="color:#f92672">-&gt;</span>height, bt <span style="color:#f92672">=</span> drw<span style="color:#f92672">-&gt;</span>scheme[ColBg].pixel, i;
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>data <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)img<span style="color:#f92672">-&gt;</span>data;
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> r <span style="color:#f92672">=</span> (bt <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x000000ff</span>), g <span style="color:#f92672">=</span> (bt <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x0000ff00</span>)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">8</span>, b <span style="color:#f92672">=</span> (bt <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x00ff0000</span>)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>;
	memcpy(tmp, data, icsz <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>); <span style="color:#75715e">// 首先使用tmp数组备份img的数据
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> icsz; <span style="color:#f92672">++</span>i) { <span style="color:#75715e">// 在img的数据上执行alpha blend，混入当前背景色
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> a <span style="color:#f92672">=</span> data[(i<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">|</span><span style="color:#ae81ff">3</span>];
		data[(i<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">2</span>)  ] <span style="color:#f92672">=</span> blend(a, r, data[(i<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">2</span>)  ]);
		data[(i<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">|</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> blend(a, g, data[(i<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">|</span><span style="color:#ae81ff">1</span>]);
		data[(i<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">|</span><span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> blend(a, b, data[(i<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">|</span><span style="color:#ae81ff">2</span>]);
	}
	XPutImage(drw<span style="color:#f92672">-&gt;</span>dpy, drw<span style="color:#f92672">-&gt;</span>drawable, drw<span style="color:#f92672">-&gt;</span>gc, img, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, x, y, img<span style="color:#f92672">-&gt;</span>width, img<span style="color:#f92672">-&gt;</span>height);

	memcpy(data, tmp, icsz <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>); <span style="color:#75715e">// 绘制完成后使用tmp复原img的数据
</span><span style="color:#75715e"></span>}
</code></pre></div><p>这样之后drw_img函数能够根据当前scheme的背景色对图标进行alpha blend，并借由之前提到的静态<strong>tmp</strong>数组实现alpha blend后的数据还原工作。图标与背景色融为一体，再无违和感。<br>
<img src="/img/dwm_window_icon/blend.png" alt=""><br>
于此，我们为DWM增加窗口图标的工作正式完结。撒花～～</p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">最后修改于 2021-06-23</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts">
			下回<br>已经到头啦。
                </a>
                
                
                
                <a class="older-posts" href="https://adamyuan.xyz/post/sasat_implementation/">
			上回<br>模拟退火求解3-SAT的C&#43;&#43;程序实现
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                


<div id="gitalk-container"></div>






            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2020 AdamYuan.
	
</div>
            </div>
    <script>
let app;

app = new Vue({
    el: '#app',
    data: {
        scrollY: 0,
        navOpacity: 0,
        isDrawerOpen: false,
        mounted: false,
        isDarkMode: false
    },
    methods: {
            sgn(t, x) {
                let k = 1. / (1. - 2 * t);
                if (x <= t) return 0;
                else if (x >= 1 - t) return 1;
                else {
                    return k * (x - t);
                }
            },
            handleScroll() {
                this.scrollY = window.scrollY;
                this.navOpacity = this.sgn(.0, Math.min(1, Math.max(0, window.scrollY / (this.pageHeadHeight() - this.navBarHeight() * 0.8))));
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;

                if (this.navOpacity >= 1) {
                    navBackground.style.opacity = 1;
                    navTitle.style.opacity = 1;
                } else {
                    navBackground.style.opacity = 0;
                    navTitle.style.opacity = 0;
                }
            },
            handleResize() {
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;
                extraContainer.style.left = (streamContainer.offsetWidth - extraContainer.offsetWidth) + 'px';
            },
            navBarHeight() {
                return this.$refs.navBar.offsetHeight;
            },
            pageHeadHeight() {
                return this.$refs.pageHead.offsetHeight;
            },
            toggleDrawer() {
                this.isDrawerOpen = !this.isDrawerOpen;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            closeDrawer() {
                this.isDrawerOpen = false;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            toggleDarkMode() {
                this.isDarkMode = !this.isDarkMode;
                if (this.isDarkMode==true){
                    document.cookie = "night=1;path=/";
                    document.body.classList.add("night");
                } else {
                    document.cookie = "night=0;path=/";
                    document.body.classList.remove("night");
                }
            }
    },
    created() {
        window.addEventListener('scroll', this.handleScroll);
        window.addEventListener('resize', this.handleResize);
        window._nonDesktop = function () {
            let check = false;
            (function (a) {
                if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
            })(navigator.userAgent || navigator.vendor || window.opera);
            return check;
        };
        
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        if (night==""){
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                
            }
        }else{
            
            if (night=="1") {
                this.toggleDarkMode();
            }
        }
    },
    mounted() {
        this.handleScroll();
        this.handleResize();
        this.mounted = true;

        
    },
    destroyed() {
        window.removeEventListener('scroll', this.handleScroll);
        window.removeEventListener('resize', this.handleResize);
    }
});
</script>

<script src="https://adamyuan.xyz//js/journal.js"></script>
    </body>
</html>
